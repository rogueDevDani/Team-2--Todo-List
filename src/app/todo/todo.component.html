<!-- Main Background Box -->
<div class="app-wrap">
  <div class="card todo-box">

    <!-- Title Row -->
    <div class="title-row">
      <img class="leaf" src="" alt="Hidden Leaf Symbol"/>
      <h2>Naruto Mission Tracker</h2>
    </div>

    <!-- Battle Section -->
    <div class="battle">
      <!-- Streak Counter -->
      <div class="streak-counter">
        ğŸ”¥ STREAK: <strong>{{currentStreak}}</strong>
      </div>

      <!-- Level Display -->
      <div class="level-display">
        <div class="scroll-image">
          <img src="scroll_small.png" alt="Scroll Image">
        </div>
        <div class="level-number">
          Level {{levelIndex + 1}}
        </div>
      </div>

      <!-- Player vs Opponent -->
      <div class="battle-container">
        <!-- Naruto -->
        <div class="fighter-box_left-fighter">
          <img [src]="currentPlayerImage" class="fighter-img" alt="Naruto">
          <div class="fighter-label">Naruto</div>
        </div>

        <!-- HP Bar -->
        <div class="hp-wrapper">
          <div class="single-hp-bar">
            <div class="hp-fill blue" [style.width.%]="playerProgressPercentage"></div>
          </div>
          <div class="hp-readout">
            <span class="naruto-progress">{{playerProgressPercentage | number:'1.0-0'}}%</span>
            <span class="opponent-progress">{{100 - playerProgressPercentage | number:'1.0-0'}}%</span>
          </div>
        </div>

        <div class="versus">VS</div>

        <!-- Opponent -->
        <div class="fighter-box_right-fighter">
          <img [src]="currentOpponentImage" [alt]="currentOpponentName" class="fighter-img">
          <div class="fighter-label">{{currentOpponentName}}</div>
        </div>
      </div>

      <!-- New game / Reset buttons -->
      <div class="battle-actions">
        <button class="btn secondary small-btn danger" (click)="startNewGame()">New Game (Lvl 1)</button>
        <button class="btn secondary small-btn" (click)="resetLevel()">Reset Battle</button>
      </div>
    </div>

    <!-- Attack Message -->
    <div class="attack-area" *ngIf="showAttack">
      <div class="attack-text">{{ attackText }}</div>
      <img *ngIf="attackGifUrl" [src]="attackGifUrl" class="attack-gif" alt="Naruto Attack" />
    </div>

    <!-- User Input Row -->
    <div class="form-row">
      <input type="text" [(ngModel)]="newTask" placeholder="Enter your mission..." (keyup.enter)="addTask()" />

      <label> Mission Rank:
        <select [(ngModel)]="priority" class="priority-select">
          <option value="D" class="rank-d">D-Rank [Novice]</option>
          <option value="C" class="rank-c">C-Rank [Genin]</option>
          <option value="B" class="rank-b">B-Rank [Chunin]</option>
          <option value="A" class="rank-a">A-Rank [Jonin]</option>
          <option value="S" class="rank-s">S-Rank [Elite]</option>
        </select>
      </label>

      <label>Due date:
        <input type="date" [(ngModel)]="newDueDate" class="date-input-field" placeholder="Due Date">
      </label>

      <button class="btn" (click)="addTask()">Add Mission</button>
    </div>

    <!-- Mission List -->
    <div class="list">
      <div *ngIf="tasks.length === 0" class="empty">No missions yet â€” add one to start the battle.</div>

      <div class="task" *ngFor="let t of tasks" [class.editing-task]="t.editing">
        <ng-container *ngIf="!t.editing">
          <div class="left">
            <input type="checkbox" [(ngModel)]="t.completed" (change)="toggleComplete(t)" />
            <div class="meta">
              <div [class.done]="t.completed" class="name">{{t.name}}</div>
              <div class="small">Due: <span>{{t.dueDate || 'â€”'}}</span></div>
            </div>
          </div>
          <div class="right">
            <div class="priority" [ngClass]="t.priority">{{t.priority}}-Rank</div>
            <button class="edit-btn" (click)="editTask(t)">âœï¸</button>
            <button class="del-btn" (click)="removeTask(t.id)">ğŸ—‘ï¸</button>
          </div>
        </ng-container>

        <ng-container *ngIf="t.editing">
          <div class="edit-fields-wrap">
            <input type="text" [(ngModel)]="t.name" class="edit-input" placeholder="Mission Name" />
            <select [(ngModel)]="t.priority" class="edit-select">
              <option value="D">D-Rank [Novice]</option>
              <option value="C">C-Rank [Genin]</option>
              <option value="B">B-Rank [Chunin]</option>
              <option value="A">A-Rank [Jonin]</option>
              <option value="S">S-Rank [Elite]</option>
            </select>
            <input type="date" [(ngModel)]="t.dueDate" class="edit-date-input" />
          </div>
          <div class="right edit-controls">
            <button class="btn small-btn save-btn" (click)="saveEdit(t)">Save</button>
            <button class="btn secondary small-btn cancel-btn" (click)="cancelEdit(t)">Cancel</button>
          </div>
        </ng-container>
      </div>
    </div>

    <!-- Rewards Overlay -->
    <div class="rewards-overlay" [class.active]="showRewardsOverlay" *ngIf="showRewardsOverlay">
      <div class="overlay-inner">
        <button class="close-btn" (click)="toggleRewardsOverlay()">âŒ</button>
        <div class="hud-title">Permanent Rewards (Milestones)</div>
        <p class="overlay-hint">Total Completed: <strong>{{ totalCompletedMissions }}</strong> Missions</p>

        <div class="reward-list-scroll">
          <div *ngFor="let reward of rewards" class="reward-item">
            <span [style.color]="reward.unlocked ? '#76ff03' : '#ffb347'">
              {{ reward.unlocked ? 'âœ…' : 'ğŸ”’' }}
              <strong class="reward-name">{{ reward.name }}</strong>
            </span>
            <span class="milestone">({{ reward.milestone }} Missions)</span>
            <div class="effect-desc" [style.color]="reward.unlocked ? '#bdf7c9' : 'var(--muted)'">
              {{ reward.unlocked ? reward.effect : reward.description }}
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Shop Overlay -->
    <div class="shop-overlay" [class.active]="showShopOverlay" *ngIf="showShopOverlay">
      <div class="overlay-inner">
        <button class="close-btn" (click)="toggleShopOverlay()">âŒ</button>
        <div class="hud-title">Shop</div>

        <div class="shop-list-scroll">
          <div *ngFor="let item of shopItems" class="shop-item">
            <span class="shop-name">{{ item.displayName }}</span>
            <button class="btn small-btn" (click)="buyOrEquipSkin(item.id)">
              {{ item.owned ? 'Equip' : 'Buy (' + item.cost + ')' }}
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Fixed HUD Buttons -->
    <button class="shop-btn fixed-btn" style="top:22px; right:22px;" (click)="toggleShopOverlay()">ğŸ›’ Shop</button>
    <button class="rewards-btn fixed-btn" (click)="toggleRewardsOverlay()">ğŸ“œ Rewards</button>

    <!-- Optional Attack Popup -->
    <div *ngIf="showAttack && !attackGifUrl" class="popup">{{ attackText }}</div>

  </div>
</div>